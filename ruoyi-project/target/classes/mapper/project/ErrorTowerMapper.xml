<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
"http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.ruoyi.project.mapper.ErrorTowerMapper">
    
    <resultMap type="ErrorTower" id="ErrorTowerResult">
        <result property="errorId"    column="error_id"    />
        <result property="towerId"    column="tower_id"    />
        <result property="name"    column="name"    />
        <result property="value"    column="value"    />
        <result property="max"    column="max"    />
        <result property="errorTime"    column="error_time"    />
    </resultMap>

    <sql id="selectErrorTowerVo">
        select error_id, tower_id, name, value, max, error_time from error_tower
    </sql>

    <select id="selectErrorTowerList" parameterType="ErrorTower" resultMap="ErrorTowerResult">
        <include refid="selectErrorTowerVo"/>
        <where>  
            <if test="towerId != null "> and tower_id = #{towerId}</if>
            <if test="name != null  and name != ''"> and name like concat('%', #{name}, '%')</if>
            <if test="value != null "> and value = #{value}</if>
            <if test="max != null "> and max = #{max}</if>
            <if test="errorTime != null "> and error_time = #{errorTime}</if>
        </where>
    </select>
    
    <select id="selectErrorTowerByErrorId" parameterType="Long" resultMap="ErrorTowerResult">
        <include refid="selectErrorTowerVo"/>
        where error_id = #{errorId}
    </select>

    <select id="selectErrorTowerBySiteId" resultType="com.ruoyi.project.domain.ErrorTower" resultMap="ErrorTowerResult">
        SELECT e.*
        FROM error_tower e
                 JOIN project_tower p ON e.tower_id = p.tower_id
        WHERE p.site_id =  #{siteId}
        ORDER BY e.tower_id, e.error_time
    </select>
    <select id="selectErrorTowerAllBySiteId" resultType="com.ruoyi.project.domain.Result" >
        SELECT DATE_FORMAT(e.error_time, '%Y-%m-%d') AS name, COUNT(*) AS num
        FROM error_tower e
                 JOIN project_tower p ON e.tower_id = p.tower_id
        WHERE p.site_id = #{siteId}
        GROUP BY DATE_FORMAT(e.error_time, '%Y-%m-%d')
        ORDER BY DATE_FORMAT(e.error_time, '%Y-%m-%d');
    </select>

    <insert id="insertErrorTower" parameterType="ErrorTower" useGeneratedKeys="true" keyProperty="errorId">
        insert into error_tower
        <trim prefix="(" suffix=")" suffixOverrides=",">
            <if test="towerId != null">tower_id,</if>
            <if test="name != null">name,</if>
            <if test="value != null">value,</if>
            <if test="max != null">max,</if>
            <if test="errorTime != null">error_time,</if>
         </trim>
        <trim prefix="values (" suffix=")" suffixOverrides=",">
            <if test="towerId != null">#{towerId},</if>
            <if test="name != null">#{name},</if>
            <if test="value != null">#{value},</if>
            <if test="max != null">#{max},</if>
            <if test="errorTime != null">#{errorTime},</if>
         </trim>
    </insert>

    <update id="updateErrorTower" parameterType="ErrorTower">
        update error_tower
        <trim prefix="SET" suffixOverrides=",">
            <if test="towerId != null">tower_id = #{towerId},</if>
            <if test="name != null">name = #{name},</if>
            <if test="value != null">value = #{value},</if>
            <if test="max != null">max = #{max},</if>
            <if test="errorTime != null">error_time = #{errorTime},</if>
        </trim>
        where error_id = #{errorId}
    </update>

    <delete id="deleteErrorTowerByErrorId" parameterType="Long">
        delete from error_tower where error_id = #{errorId}
    </delete>

    <delete id="deleteErrorTowerByErrorIds" parameterType="String">
        delete from error_tower where error_id in 
        <foreach item="errorId" collection="array" open="(" separator="," close=")">
            #{errorId}
        </foreach>
    </delete>
</mapper>